name: "Manual Release"

on:
    workflow_dispatch:

jobs:
    deploy-and-release:
        name: "Version bump and release (main branch)"
        runs-on: ubuntu-latest
        permissions:
            contents: write
            packages: write

        steps:
            - name: Checkout main
              uses: actions/checkout@v4
              with:
                  ref: main
                  fetch-depth: 0

            - name: Ensure latest main commit has successful build-test-deploy
              env:
                  GITHUB_TOKEN: ${{ github.token }}
                  GH_TOKEN: ${{ github.token }}
              run: |
                  HEAD_SHA=$(git rev-parse HEAD)
                  echo "Current main HEAD: $HEAD_SHA"
                  
                  # Fetch latest successful runs of the build-test-deploy workflow on main
                  runs_json=$(gh api repos/$GITHUB_REPOSITORY/actions/workflows/build-test-deploy.yml/runs \
                    -F branch=main -F status=success -F per_page=10)
                  
                  # Check if any successful run matches this HEAD_SHA
                  match=$(echo "$runs_json" | jq -r --arg sha "$HEAD_SHA" '
                    .workflow_runs[] | select(.head_sha == $sha) | .conclusion' | head -n1)
                  
                  if [ "$match" != "success" ]; then
                    echo "No successful 'build-test-deploy.yml' run found for HEAD $HEAD_SHA on main."
                    echo "Please ensure the build workflow on main completes successfully before releasing."
                    exit 1
                  fi
                  
                  echo "Verified successful build-test-deploy run for main@$HEAD_SHA."

            - name: Setup Java 21
              uses: actions/setup-java@v4
              with:
                  java-version: "21"
                  distribution: "temurin"
                  cache: "maven"

            - name: Cache Maven repository
              uses: actions/cache@v4
              with:
                  path: ~/.m2/repository
                  key: maven-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}

            - name: Resolve dependencies
              run: mvn -B -q dependency:go-offline

            - name: Compute semver version
              id: semver
              run: |
                  semver=$(date -u '+%Y.%m.%j%H%M')
                  echo "semver=${semver}" >> "$GITHUB_OUTPUT"

            - name: Set version and commit on main
              run: |
                  mvn -B -q versions:set -DnewVersion=${{ steps.semver.outputs.semver }} -DgenerateBackupPoms=false
                  
                  git add pom.xml
                  git config user.name "github-actions[bot]"
                  git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
                  
                  if git diff --cached --quiet; then
                    echo "No version changes to commit."
                  else
                    git commit -m "chore: release ${{ steps.semver.outputs.semver }}"
                    git push origin main
                  fi

            - name: Import GPG key
              run: |
                  mkdir -p ~/.gnupg
                  chmod 700 ~/.gnupg
                  echo "$GPG_PRIVATE_KEY" | gpg --batch --import
                  gpg --list-secret-keys
              env:
                  GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}

            - name: Configure GPG for non-interactive use
              run: |
                  echo "allow-loopback-pinentry" >> ~/.gnupg/gpg-agent.conf
                  echo "pinentry-mode loopback" >> ~/.gnupg/gpg.conf

            - name: Create settings.xml (central)
              run: |
                  mkdir -p "$HOME/.m2"
                  cat > "$HOME/.m2/settings.xml" <<EOF
                  <settings>
                    <servers>
                      <server>
                        <id>central</id>
                        <username>${CENTRAL_USERNAME}</username>
                        <password>${CENTRAL_PASSWORD}</password>
                      </server>
                    </servers>
                  </settings>
                  EOF
              env:
                  CENTRAL_USERNAME: ${{ secrets.CENTRAL_USERNAME }}
                  CENTRAL_PASSWORD: ${{ secrets.CENTRAL_PASSWORD }}

            - name: Deploy to Maven Central (release profile)
              run: mvn -B -P release deploy -s "$HOME/.m2/settings.xml"
              env:
                  MAVEN_GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}

            - name: Determine version after deploy
              id: ver
              run: |
                  version=$(mvn -q -Dexpression=project.version -DforceStdout help:evaluate)
                  echo "version=${version}" >> "$GITHUB_OUTPUT"

            - name: Find JAR
              id: jar
              run: |
                  jar_path=$(ls target/*.jar | head -n 1)
                  echo "jar_path=${jar_path}" >> "$GITHUB_OUTPUT"

            - name: Create GitHub release with autogenerated notes
              env:
                  GITHUB_TOKEN: ${{ github.token }}
                  GH_TOKEN: ${{ github.token }}
                  VERSION: ${{ steps.ver.outputs.version }}
                  JAR_PATH: ${{ steps.jar.outputs.jar_path }}
              run: |
                  gh release create "$VERSION" "$JAR_PATH" \
                    --repo "$GITHUB_REPOSITORY" \
                    --title "$VERSION" \
                    --generate-notes
