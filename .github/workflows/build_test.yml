name: "Build & Test"

on:
    push:
        branches:
            - "**"

concurrency:
    group: "build-${{ github.event.repository.name }}"

jobs:
    build:
        name: "Build with coverage"
        runs-on: ubuntu-latest
        permissions:
            contents: read

        steps:
            - name: Checkout
              uses: actions/checkout@v6

            - name: Setup Java 21
              uses: actions/setup-java@v5
              with:
                  java-version: "21"
                  distribution: "temurin"
                  cache: "maven"

            - name: Cache Maven repository
              uses: actions/cache@v5
              with:
                  path: ~/.m2/repository
                  key: maven-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}

            - name: Resolve dependencies
              run: mvn -B -q dependency:go-offline

            - name: Run tests with coverage
              run: mvn -B verify

            - name: JaCoCo coverage summary
              run: |
                  if [ ! -f target/site/jacoco/jacoco.xml ]; then
                    echo "No JaCoCo report found"
                    exit 1
                  fi
                  jacoco_report=$(find . -type f -name "jacoco.xml" | head -n 1)
                  echo "Jacoco report: ${jacoco_report}"
                  echo "jacoco_report=${jacoco_report}" >> $GITHUB_OUTPUT
                  
                  # Print coverage details from jacoco report
                  if [ -n "$jacoco_report" ] && [ -f "$jacoco_report" ]; then
                    # Get the LAST LINE counter (totals)
                    line=$(
                      awk '{
                        s=$0
                        while (match(s, /<counter[^>]*type="LINE"[^>]*\/>/)) {
                          last = substr(s, RSTART, RLENGTH)
                          s = substr(s, RSTART + RLENGTH)
                        }
                      } END {
                        if (last) print last
                      }' "$jacoco_report")
                      if [ -n "$line" ]; then
                        cov=$(printf '%s\n' "$line" | sed -n 's/.*covered="\([0-9][0-9]*\)".*/\1/p')
                        miss=$(printf '%s\n' "$line" | sed -n 's/.*missed="\([0-9][0-9]*\)".*/\1/p')
                        cov=${cov:-0}
                        miss=${miss:-0}
                        total=$(( cov + miss ))
                        if [ "$total" -gt 0 ]; then
                          pc=$(awk -v c="$cov" -v t="$total" 'BEGIN{ printf "%.2f", (100.0*c)/t }')
                        else
                          pc=0.00
                        fi
                        echo "Total Coverage: ${pc}% (${cov}/${total} lines)"
                      else
                        echo "No LINE counter found in ${jacoco_report}."
                      fi
                  else
                    echo "No Jacoco XML report found."
                    exit 1
                  fi

            - name: Upload JaCoCo HTML report
              uses: actions/upload-artifact@v6
              with:
                  name: jacoco-report-${{ github.ref_name }}
                  path: target/site/jacoco/
